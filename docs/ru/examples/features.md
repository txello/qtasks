# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á QTasks

QTasks –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–∏–±–∫—É—é —Å–∏—Å—Ç–µ–º—É –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π –∑–∞–¥–∞—á –∏ –∏—Ö –ø–æ–≤–µ–¥–µ–Ω–∏—è. –ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–¥–∞—á, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ.

---

## üì¶ shared\_task

`shared_task` –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `QueueTasks`, –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–ª–∏ –æ–±—â–∏—Ö –∑–∞–¥–∞—á.

```python
@shared_task()
def shared_func():
    print("–û–±—â–∞—è –∑–∞–¥–∞—á–∞")
```

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–µ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —á—Ç–æ –∏ `@app.task`, –≤–∫–ª—é—á–∞—è:

* `executor`
* `middlewares`
* `generate_handler`
* `echo`
* `awaiting`

---

## üîÄ router\_tasks

`Router` ‚Äî –º–µ—Ö–∞–Ω–∏–∑–º –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á, –æ—Ç–¥–µ–ª—ë–Ω–Ω—ã–π –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ `QueueTasks`-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ –Ω–∞–±–æ—Ä—ã –∑–∞–¥–∞—á.

```python
from qtasks import Router

router = Router(method="sync")

@router.task()
def example():
    print("Router task")
```

–í `main.py`:

```python
app.include_router(router)
```

---

## üì£ echo=True –∏ self: Task

–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ `echo=True`, QTasks –ø–µ—Ä–µ–¥–∞—ë—Ç –ø–µ—Ä–≤—ã–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º –≤ –∑–∞–¥–∞—á—É –µ—ë —ç–∫–∑–µ–º–ø–ª—è—Ä `self`:

* –î–ª—è `async` ‚Äî `AsyncTask`
* –î–ª—è `sync` ‚Äî `SyncTask`

```python
@app.task(echo=True)
async def echo_task(self: AsyncTask):
    print(self.task_name)
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å `self.add_task(...)`, –ø–æ–ª—É—á–∞—Ç—å `self.ctx` –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏.

---

## üß† self.ctx ‚Äî —ç—Ç–æ (A)SyncContext

–ö–æ–Ω—Ç–µ–∫—Å—Ç `self.ctx` –¥–∞—ë—Ç –¥–æ—Å—Ç—É–ø –∫:

* `task_uuid`
* `get_logger()`
* `get_broker()` / `get_storage()` / `get_config()`
* `cancel()` ‚Äî –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –æ—Ç–º–µ–Ω—É –∑–∞–¥–∞—á–∏

```python
@app.task(echo=True)
def show_context(self: SyncTask):
    print(self.ctx.task_uuid)
    self.ctx.cancel()  # –≤—ã–∑–æ–≤–µ—Ç TaskCancelError –≤–Ω—É—Ç—Ä–∏ –∑–∞–¥–∞—á–∏
```

`self.ctx.cancel()` –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ `TaskCancelError` –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏. –≠—Ç–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤–æ—Ä–∫–µ—Ä–æ–º –∏ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –∑–∞–¥–∞—á–∏ –≤ —Å—Ç–∞—Ç—É—Å `CANCEL`.

–≠—Ç–æ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞.

---

## üîÅ retry –∏ retry\_on\_exc

–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ `retry=N`, –∑–∞–¥–∞—á–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞ `N` —Ä–∞–∑ –ø—Ä–∏ –æ—à–∏–±–∫–µ.
–ï—Å–ª–∏ –∑–∞–¥–∞–Ω–æ `retry_on_exc=[...]`, —Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å **—Ç–æ–ª—å–∫–æ** –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Ç–∏–ø–∞—Ö –æ—à–∏–±–æ–∫.

```python
@app.task(retry=5, retry_on_exc=[ZeroDivisionError])
def retryable():
    1 / 0
```

---

## ‚öôÔ∏è executor

–ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `AsyncTaskExecutor` / `SyncTaskExecutor` –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π.

```python
@shared_task(executor=MySyncTaskExecutor)
def custom_exec():
    print("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π executor")
```

---

## üß© middlewares

–ú–∞—Å—Å–∏–≤ middleware'–æ–≤, –≤—ã–∑—ã–≤–∞–µ–º—ã—Ö –≤–Ω—É—Ç—Ä–∏ executor'–∞ –¥–æ –∏ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏. –ü–æ–∑–≤–æ–ª—è—é—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –¥–æ/–ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ –∑–∞–¥–∞—á–∏.

```python
@shared_task(middlewares=[MyTaskMiddleware])
def with_mw():
    print("middleware")
```

---

## ü™¢ awaiting=True (—Ç–æ–ª—å–∫–æ –¥–ª—è shared\_task)

–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω `awaiting=True`, `shared_task` –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `AsyncTask`, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–±—ä—è–≤–ª–µ–Ω–∞ –∫–∞–∫ `async def`.

```python
@shared_task(awaiting=True)
async def async_shared():
    print("async shared task")
```

–≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ –¥—Ä—É–≥–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.
