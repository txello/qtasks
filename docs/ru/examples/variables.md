# –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö –∑–∞–¥–∞—á

`QTasks` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏–∫–æ–π –∑–∞–¥–∞—á:

* **Depends** ‚Äî –≤—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø—Ä–∏
–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏.
* **State** ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ–±–º–µ–Ω —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏.

---

## üîß –ü—Ä–∏–º–µ—Ä 1: Depends (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)

`Depends` –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å
–ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏.
–§—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Å—Ç–æ–π, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–Ω–æ–π –∏–ª–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.

```python
from qtasks.plugins import Depends
from contextlib import asynccontextmanager

@asynccontextmanager
async def get_db():
    db = await connect_to_db()
    yield db
    print("close...")
    await db.disconnect()

@app.task
async def test_depends(depends: Depends(get_db)):
    depends.execute(...)
    print("–í—ã–∑–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω")
    return
```

**–í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å:**

```bash
<–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç –∑–∞–¥–∞—á—É>
–í—ã–∑–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω
<–°–µ—Ä–≤–µ—Ä –∑–∞–≤–µ—Ä—à–∞–µ—Ç –∑–∞–¥–∞—á—É>
close...
```

**–ò—Ç–æ–≥:** –∑–∞–¥–∞—á–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î, –∫–æ—Ç–æ—Ä–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è.

---

## üîß –ü—Ä–∏–º–µ—Ä 2: State (—Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏)

`State` ‚Äî —ç—Ç–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö, –¥–æ—Å—Ç—É–ø–Ω–æ–µ –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —à–∞–≥–æ–≤ –æ–¥–Ω–æ–π –ª–æ–≥–∏–∫–∏.

```python
from qtasks.plugins import AsyncState

class MyState(AsyncState):
    pass

@app.task
async def step1(state: MyState):
    await state.set("state", "await_phone")
    await state.update(step=1, prompt="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω")
    return "ok"

@app.task
async def step2(state: MyState):
    print(await state.get_all())

    cur = await state.get("state")
    if cur != "await_phone":
        return "error"
    await state.update(step=2)
    await state.delete("state")
    await state.clear()
    return "ok"
```

**–í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å:**

```bash
{"state": "await_phone", "step": 1, "prompt": "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω"}
```

**–ò—Ç–æ–≥:** –ø–µ—Ä–≤—ã–π —à–∞–≥ –∑–∞–ø–∏—Å–∞–ª –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –≤—Ç–æ—Ä–æ–π —à–∞–≥ –∏—Ö –ø—Ä–æ—á–∏—Ç–∞–ª, –ø—Ä–æ–≤–µ—Ä–∏–ª
–∏ –æ—á–∏—Å—Ç–∏–ª.

---

## ‚öôÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ `QTasks`?

* **Depends** —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∑–∞–¥–∞—á–∏ –∏ —Ñ—É–Ω–∫—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏
–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ TaskExecutor. –≠—Ç–æ —É–¥–æ–±–Ω–æ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î, API –∏–ª–∏ –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–∞–º.
* **State** —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–∞–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ key-value —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –û–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç
`set`, `update`, `get`, `delete`, `clear`, –∞ —Ç–∞–∫–∂–µ —á—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑–æ–º (`get_all`).

---

## üè¢ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–º–ø–∞–Ω–∏–∏

–î–æ–ø—É—Å—Ç–∏–º, —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –ø–æ—à–∞–≥–æ–≤–∞—è —Ñ–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:

1. `step1` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
2. `step2` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –≤–≤–µ–¥—ë–Ω —Ç–µ–ª–µ—Ñ–æ–Ω, –∏ –¥–≤–∏–≥–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –¥–∞–ª—å—à–µ.

–ü—Ä–∏ —ç—Ç–æ–º `Depends` –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–∞–∑–µ, –∞ `State`
‚Äî –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

## ‚úÖ –ò—Ç–æ–≥–∏

* **Depends** ‚Äî –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (—Ä–µ—Å—É—Ä—Å—ã, –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã, —Å–µ—Ä–≤–∏—Å—ã).
* **State** ‚Äî –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏.

–í–º–µ—Å—Ç–µ –æ–Ω–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç —Å—Ç—Ä–æ–∏—Ç—å –≥–∏–±–∫–∏–µ –ø–∞–π–ø–ª–∞–π–Ω—ã: –æ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π —Å –ë–î –¥–æ —á–∞—Ç-–±–æ—Ç–æ–≤
–∏ —Å–ª–æ–∂–Ω—ã—Ö –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
