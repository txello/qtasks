# Конфигурация

Эта страница описывает архитектурную модель конфигурации в QTasks: как она устроена,
как распространяется между компонентами и каким образом изменения параметров
автоматически отражаются на всей системе.

В отличие от конфигураций, распределённых по компонентам или завязанных на глобальные
переменные, QTasks использует единый, типизированный источник конфигурации.

---

## Единая схема конфигурации

Вся конфигурация QTasks хранится в одной dataclass-схеме — `QueueConfig`.

Экземпляр конфигурации:

* создаётся по умолчанию при инициализации `QueueTasks`;
* доступен как `app.config`;
* передаётся во все компоненты при их создании в виде параметра `config=config`;
* сохраняется компонентами как `self.config`.

Если компонент не получил конфигурацию явно, он обязан создать собственный
экземпляр `QueueConfig`. Это позволяет использовать компоненты изолированно, без
зависимости от глобального состояния приложения.

---

## Конфигурация как архитектурный контракт

`QueueConfig` является не просто набором параметров, а частью архитектурного
контракта между компонентами.

Через конфигурацию:

* задаются параметры поведения компонентов;
* обеспечивается согласованность настроек между ними;
* реализуется централизованное обновление критичных параметров.

Компоненты не синхронизируют свои настройки напрямую друг с другом — они опираются
исключительно на конфигурацию.

---

## Механизм подписки на изменения

Одной из ключевых особенностей `QueueConfig` является поддержка подписки на
изменения параметров.

Для этого используются два механизма:

* `subscribe` — регистрация обработчиков изменений;
* `_notify` — уведомление подписчиков при изменении значения.

Уведомление происходит автоматически в момент изменения атрибута через `setattr`.

---

## Функция subscribe

`subscribe` позволяет подписаться на изменение как существующих, так и динамически
добавленных параметров конфигурации.

Подписчик получает следующие аргументы:

* `config: QueueConfig` — экземпляр конфигурации;
* `key` — имя изменённого параметра;
* `value` — новое значение параметра.

Таким образом, компонент или подсистема может реагировать на изменения конфигурации
без опроса состояния.

---

## Автоматическое распространение изменений

По умолчанию подписка на изменения конфигурации регистрируется в `QueueTasks.__init__`.

Она привязана к внутреннему методу:

```text
self._update_configs()
```

Этот метод отвечает за синхронизацию критичных параметров между компонентами.

На момент написания документации он используется, в частности, для обновления
логгеров компонентов:

```text
component.log.update_logger(**kwargs)
```

Таким образом, изменение конфигурации приводит к немедленному обновлению состояния
компонентов без их перезапуска.

---

## Динамические параметры конфигурации

Архитектура `QueueConfig` допускает добавление параметров во время выполнения.

Такие параметры:

* становятся частью общей конфигурации;
* участвуют в механизме подписки;
* могут использоваться как компонентами, так и плагинами.

Это позволяет расширять конфигурацию без изменения базовой схемы и без нарушения
совместимости компонентов.

---

## Границы ответственности

* `QueueConfig` отвечает за хранение и распространение параметров;
* компоненты отвечают за реакцию на изменения, а не за их координацию;
* конфигурация не содержит логики выполнения задач.

Такое разделение делает систему конфигурации предсказуемой, расширяемой и
безопасной для сложных сценариев.

---

## Архитектурные инварианты

* в системе существует единый источник конфигурации;
* конфигурация типизирована и сериализуема;
* изменения параметров распространяются автоматически;
* компоненты не зависят от глобального состояния.

Эта модель конфигурации позволяет QTasks оставаться согласованным даже при
динамических изменениях во время работы.
